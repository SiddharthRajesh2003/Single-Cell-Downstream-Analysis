# Loading our neccessary libraries

```{r}
library(Seurat)
library(ggplot2)
library(tidyverse)
library(patchwork)
library(pheatmap)
```

## Create plots directory if it doesn't exist

```{r}
if (!dir.exists("plots")) dir.create('plots')
```

# Loading our data

```{r}
data.dir <- 'data/'

extract_sample_names <- function(data.dir, file_pattern = "_features\\.tsv\\.gz$") {
    feature.files <- list.files(data.dir, pattern = file_pattern, full.names = FALSE)
    sample_names <- gsub(file_pattern, "", feature.files)
    return(sort(sample_names))
}

sample_names <- extract_sample_names(data.dir)
cat("Found ", length(sample_names), "samples\n")
print(sample_names)
```

## Load individual samples as Seurat Objects

```{r}
if (!file.exists('data/seurat_objs.Rdata')){
    seurat_list <- list()

    read_10X_with_prefix <- function(sample_name, data_dir){
        matrix.path <- file.path(data_dir, paste0(sample_name, "_matrix.mtx.gz"))
        features.path <- file.path(data_dir, paste0(sample_name, "_features.tsv.gz"))
        barcodes.path <- file.path(data_dir, paste0(sample_name, "_barcodes.tsv.gz"))

        if(all(file.exists(c(matrix.path, features.path, barcodes.path)))) {
            temp_dir <- file.path(tempdir(), sample_name)
            dir.create(temp_dir, showWarnings = FALSE)

            file.copy(matrix.path, file.path(temp_dir, 'matrix.mtx.gz'))
            file.copy(features.path, file.path(temp_dir, 'features.tsv.gz'))
            file.copy(barcodes.path, file.path(temp_dir, 'barcodes.tsv.gz'))

            counts <- Read10X(data.dir = temp_dir)
            unlink(temp_dir, recursive = TRUE)

            return(counts)
        } else {
            stop(paste("Files not found for sample:", sample_name))
        }
    }

    for (sample_name in sample_names){
        cat("Loading sample:", sample_name, "\n")
        counts <- read_10X_with_prefix(sample_name, data.dir)
        seurat_obj <- CreateSeuratObject(counts = counts, project = sample_name, min.cells = 3, min.features = 200)

        # Add metadata
        seurat_obj$sample <- sample_name
        # Extract group (Control or OSA) from sample name
        if (grepl("Control", sample_name)) {
            seurat_obj$Group <- "Control"
        } else if (grepl("OSA", sample_name)) {
            seurat_obj$Group <- "OSA"
        } else {
            seurat_obj$Group <- "Unknown"
        }

        seurat_list[[sample_name]] <- seurat_obj
    }
    save(seurat_list, file = 'data/seurat_objs.Rdata')
} else {
    load('data/seurat_objs.Rdata')
}

cat("\nLoaded", length(seurat_list), "samples\n")
```

### Checking the Quality of the samples before performing QC

```{r}
create_violin_plots <- function(seurat_list){
    plot_list <- list()

    for (sample_name in names(seurat_list)){
        sample.obj <- seurat_list[[sample_name]]

        sample.obj[['percent_mt']] <- PercentageFeatureSet(sample.obj, pattern = '^MT-')
        sample.obj[['percent_rb']] <- PercentageFeatureSet(sample.obj, pattern = '^RP[SL]')
        sample.obj$log10GenesPerUMI <- log10(sample.obj$nFeature_RNA) / log10(sample.obj$nCount_RNA)

        vln <- VlnPlot(sample.obj, features = c("nFeature_RNA", "nCount_RNA", "percent_mt"), cols = 3, pt.size = 0.1) +
            plot_annotation(title = paste("QC Metrics -", sample_name))

        plot_list[[sample_name]] <- vln
    }
    return(plot_list)
}

vln_plots <- create_violin_plots(seurat_list)

# Combine, save, and view in one go
combined_plot <- wrap_plots(vln_plots, ncol = 3)
ggsave("plots/violin_plots_before_qc.png", combined_plot, width = 70, height = 50, dpi = 300, limitsize = FALSE)
```

## Performing QC on the samples

```{r}
cat("\n=== Performing Quality Control ===\n")

max_genes <- 5000
min_genes <- 500
max_UMI <- 20000
min_UMI <- 100
max_percent_mt <- 20
min_percent_mt <- 0.5  # Changed from 1 to 0.5 to be less stringent

qc_stats <- data.frame()

for (sample_name in names(seurat_list)){
    sample.obj <- seurat_list[[sample_name]]

    # Join layers if using Seurat v5
    if (inherits(sample.obj[["RNA"]], "Assay5")) {
      sample.obj[["RNA"]] <- JoinLayers(sample.obj[["RNA"]])
    }

    # Calculate QC metrics
    sample.obj[['percent_mt']] <- PercentageFeatureSet(sample.obj, pattern = '^MT-')
    sample.obj[['percent_rb']] <- PercentageFeatureSet(sample.obj, pattern = '^RP[SL]')
    sample.obj$log10GenesPerUMI <- log10(sample.obj$nFeature_RNA) / log10(sample.obj$nCount_RNA)
    sample.obj@meta.data <- separate(sample.obj@meta.data, col='sample', into = c('Sample_ID', 'Group'), sep = '_')

    # Record pre-filter stats
    pre_cells <- ncol(sample.obj)

    # Filter cells
    sample.obj <- subset(sample.obj, subset = nFeature_RNA > min_genes &
                                              nFeature_RNA < max_genes &
                                              nCount_RNA > min_UMI &
                                              nCount_RNA < max_UMI &
                                              percent_mt < max_percent_mt &
                                              percent_mt > min_percent_mt)

    post_cells <- ncol(sample.obj)

    cat(sample_name, ": ", pre_cells, " -> ", post_cells, " cells (",
        round(100*post_cells/pre_cells, 1), "% retained)\n", sep="")

    qc_stats <- rbind(qc_stats, data.frame(
        sample = sample_name,
        group = sample.obj$Group[1],
        cells_before = pre_cells,
        cells_after = post_cells,
        percent_retained = 100*post_cells/pre_cells
    ))

    seurat_list[[sample_name]] <- sample.obj
}

write.csv(qc_stats, "plots/qc_summary.csv", row.names = FALSE)
cat("\nQC summary saved to plots/qc_summary.csv\n")
vln_plots <- create_violin_plots(seurat_list)

# Combine, save, and view in one go
combined_plot <- wrap_plots(vln_plots, ncol = 3)
ggsave("plots/violin_plots_after_qc.png", combined_plot, width = 70, height = 50, dpi = 300, limitsize = FALSE)
```

# Merging together all the Seurat Objects into a single Seurat Object

```{r}
cat("\n=== Merging samples ===\n")

if (length(seurat_list) > 1){
    merged_seurat <- merge(seurat_list[[1]],
                          y = seurat_list[2:length(seurat_list)],
                          add.cell.ids = names(seurat_list),
                          project = "Control_vs_OSA")
} else {
    merged_seurat <- seurat_list[[1]]
}

# Join layers if using Seurat v5
if (inherits(merged_seurat[["RNA"]], "Assay5")) {
  merged_seurat[["RNA"]] <- JoinLayers(merged_seurat[["RNA"]])
}

merged_seurat@meta.data <- separate(merged_seurat@meta.data, col='orig.ident', into = c('Sample_ID', 'Group'), sep = '_')

cat("Merged dataset:", ncol(merged_seurat), "cells,", nrow(merged_seurat), "genes\n")
```

# Standard Normalization and scaling

```{r}
cat("\n=== Normalizing and scaling data ===\n")
merged_seurat <- NormalizeData(merged_seurat)
merged_seurat <- FindVariableFeatures(merged_seurat, selection.method = "vst", nfeatures = 2000)
merged_seurat <- ScaleData(merged_seurat)
```

# PCA

```{r}
cat("\n=== Running PCA ===\n")
if (!file.exists('data/merged_seurat_after_pca.rds')){
    merged_seurat <- RunPCA(merged_seurat, features = VariableFeatures(object = merged_seurat), verbose = FALSE)
    saveRDS(merged_seurat, file = 'data/merged_seurat_after_pca.rds')
} else{
    merged_seurat <- readRDS('data/merged_seurat_after_pca.rds')
}
```

# Elbow Plot to choose the number of Principle Components

```{r}
elbow <- ElbowPlot(merged_seurat, ndims = 50)
jpeg('plots/elbow_plot_before_integration.png')
print(elbow)
dev.off()
```



# Clustering and UMAP before Integration

```{r}
cat("\n=== Clustering before integration ===\n")
merged_seurat <- FindNeighbors(merged_seurat, dims = 1:30)
merged_seurat <- FindClusters(merged_seurat, resolution = 0.5)
if (!file.exists('data/merged_seurat_after_umap.rds')) {
    merged_seurat <- RunUMAP(merged_seurat, dims = 1:30)
    saveRDS(merged_seurat, file ='data/merged_seurat_after_umap.rds')
} else {
    merged_seurat <- readRDS('data/merged_seurat_after_umap.rds')
}

cat("Creating UMAP plots before integration...\n")
umap_coords <- as.data.frame(merged_seurat@reductions$umap@cell.embeddings)
colnames(umap_coords) <- c("UMAP_1", "UMAP_2")
umap_coords$Group <- merged_seurat@meta.data$Group
umap_coords$Sample <- merged_seurat@meta.data$Sample_ID
umap_coords$Cluster <- merged_seurat@meta.data$seurat_clusters

# UMAP by Group
p1 <- ggplot(umap_coords, aes(x = UMAP_1, y = UMAP_2, color = Group)) +
  geom_point(size = 0.3, alpha = 0.6) +
  theme_classic() +
  theme(legend.position = "right") +
  labs(title = "UMAP Before Integration (by Group)") +
  scale_color_manual(values = c("Control" = "#4DBBD5", "OSA" = "#E64B35"))

png('plots/UMAP_before_integration_by_group.png', width = 2400, height = 2000, res = 300)
print(p1)
dev.off()

# UMAP by Cluster
p2 <- ggplot(umap_coords, aes(x = UMAP_1, y = UMAP_2, color = Cluster)) +
  geom_point(size = 0.3, alpha = 0.6) +
  theme_classic() +
  theme(legend.position = "right") +
  labs(title = "UMAP Before Integration (by Cluster)")

png('plots/UMAP_before_integration_by_cluster.png', width = 2400, height = 2000, res = 300)
print(p2)
dev.off()

# UMAP split by Group
p3 <- ggplot(umap_coords, aes(x = UMAP_1, y = UMAP_2, color = Cluster)) +
  geom_point(size = 0.3, alpha = 0.6) +
  facet_wrap(~Group) +
  theme_classic() +
  theme(legend.position = "right") +
  labs(title = "UMAP Before Integration (split by Group)")

png('plots/UMAP_before_integration_split.png', width = 3000, height = 1500, res = 300)
print(p3)
dev.off()
```


# Integration with Seurat v5 workflow

```{r}
if (!file.exists('data/seurat_integrated.rds')){
    # For Seurat v5: split by sample for integration
    merged_seurat[["RNA"]] <- split(merged_seurat[["RNA"]], f = merged_seurat$Sample_ID)

    # Normalize and find variable features for each sample
    merged_seurat <- NormalizeData(merged_seurat)
    merged_seurat <- FindVariableFeatures(merged_seurat)
    merged_seurat <- ScaleData(merged_seurat)
    merged_seurat <- RunPCA(merged_seurat)

    # Integrate
    seurat_integrated <- IntegrateLayers(
        object = merged_seurat,
        method = CCAIntegration,
        orig.reduction = "pca",
        new.reduction = "integrated.cca",
        verbose = TRUE
    )

    # Rejoin layers after integration
    seurat_integrated[["RNA"]] <- JoinLayers(seurat_integrated[["RNA"]])

    saveRDS(seurat_integrated, file='data/seurat_integrated.rds')
} else {
    seurat_integrated <- readRDS('data/seurat_integrated.rds')
}
```

# Post-Integration Clustering, UMAP and TSNE

```{r}
cat("\n--- Step 1: Clustering on integrated data ---\n")

if (!file.exists('data/seurat_integrated_after_clustering.rds')) {
    seurat_integrated <- FindNeighbors(seurat_integrated,
                                        reduction = 'integrated.cca',
                                        dims = 1:30)

    seurat_integrated <- FindClusters(seurat_integrated,
                                        resolution = 0.2,
                                        algorithm = 1)

    seurat_integrated <- RunUMAP(seurat_integrated,
                                reduction = 'integrated.cca',
                                dims = 1:30)

    seurat_integrated <- RunTSNE(seurat_integrated,
                                reduction = 'integrated.cca',
                                dims = 1:30,
                                perplexity = 30,
                                check_duplicates = FALSE)

    saveRDS(seurat_integrated, file="data/seurat_integrated_after_clustering.rds")
} else {
    seurat_integrated <- readRDS("data/seurat_integrated_after_clustering.rds")
}
```

# T-SNE plots

```{r}
seurat_integrated$Condition <- ifelse(grepl("^Control", seurat_integrated$Group), "Control", "OSA")

p1_tsne_group <- DimPlot(seurat_integrated, reduction = 'tsne', group.by = 'Condition')+
  ggtitle("t-SNE by Condition") +
  theme_classic()
png('plots/tsne_by_condition.png', width = 3000, height = 1500, res = 300)
print(p1_tsne_group)
dev.off()

p2_tsne_cluster <- DimPlot(seurat_integrated,
                            reduction = 'tsne',
                            group.by = 'seurat_clusters',
                            label = TRUE,
                            repel=TRUE) +
                    ggtitle('t-SNE by Cluster') +
                    theme_classic() +
                    theme(legend.position = 'right')
png('plots/tsne_by_cluster.png', width = 3000, height = 1500, res = 300)
print(p2_tsne_cluster)
dev.off()

p3_tsne <- DimPlot(seurat_integrated,
                    reduction = 'tsne',
                    split.by = 'Condition',
                    group.by = 'seurat_clusters',
                    label = TRUE) +
            ggtitle('t-SNE split by Condition') + 
            theme_classic()
png('plots/tsne_split_by_condition.png', width = 3000, height = 1500, res = 300)        
print(p3_tsne)
dev.off()
```

# UMAP Plots

```{r}
p1_umap_group <- DimPlot(seurat_integrated,
                         reduction = 'umap',
                        group.by = 'Condition') +
                ggtitle('UMAP by Condition') +
                theme_classic()
png('plots/UMAP_after_integration_condition.png', width = 3000, height = 1500, res = 300)                                
print(p1_umap_group)
dev.off()

p2_umap_cluster <- DimPlot(seurat_integrated,
                            reduction = 'umap',
                            group.by = 'seurat_clusters',
                            label = TRUE,
                            repel=TRUE) +
                    ggtitle('UMAP by Cluster') +
                    theme_classic() +
                    theme(legend.position = 'right')
png('plots/UMAP_after_integration_cluster.png', width = 3000, height = 1500, res = 300)
print(p2_umap_cluster)
dev.off()

p3_umap <- DimPlot(seurat_integrated,
                    reduction = 'umap',
                    split.by = 'Condition',
                    group.by = 'seurat_clusters',
                    label = TRUE) +
            ggtitle('UMAP split by Condition') + 
            theme_classic()
png('plots/UMAP_after_integration_split_by_condition.png', width = 3000, height = 1500, res = 300)
print(p3_umap)
dev.off()
```

# Cell Annotation using PBMC markers

## Defining PBMC cell type markers
```{r}
cat('\n--- Step 2: Annotating cell types using PBMC markers ---\n')

pbmc_markers <- list(
    # T-cell markers
    'T_cells' = c("CD3D", 'CD3E', 'CD3G'),
  "T_Helper" = c("CD4", "IL7R"),
  "T_Cytotoxic" = c("CD8A", "CD8B"),
  "T_Regulatory" = c("FOXP3", "IL2RA", "CTLA4"),
  "T_Naive" = c("CCR7", "SELL", "TCF7"),
  "T_Memory" = c("IL7R", "CD44"),
  
  # B-cell markers
  "B_Cells" = c("CD79A", "MS4A1", "CD19"),
  "B_Naive" = c("IGHD", "TCL1A"),
  "B_Memory" = c("CD27", "TNFRSF13B"),
  "Plasmablast" = c("IGHG1", "MZB1", "SDC1", "XBP1"),
  
  # Myeloid markers
  "Monocytes_Classical" = c("CD14", "S100A8", "S100A9"),
  "Monocytes_NonClassical" = c("FCGR3A", "MS4A7", "CD16"),
  "cDC" = c("FCER1A", "CD1C"),
  "pDC" = c("LILRA4", "IL3RA", "IRF7"),
  
  # NK cells
  "NK_Cells" = c("GNLY", "NKG7", "NCAM1", "KLRD1"),
  
  # Other
  "Platelets" = c("PPBP", "PF4"),
  "Erythroblast" = c("HBA1", "HBB")
)
```

## Scoring the cells for each marker set

```{r}
for (cell_type in names(pbmc_markers)) {
    genes <- pbmc_markers[[cell_type]]
    genes_present <- genes[genes %in% rownames(seurat_integrated)]

    if (length(genes_present) > 0)  {
        seurat_integrated <- AddModuleScore(
            seurat_integrated,
            features = list(genes_present),
            name = paste0(cell_type, "_score")
        )
    }
}
```

## Feature Plots for key markers

```{r}
key_markers <- c("CD3D", "CD4", "CD8A", "CD79A", "MS4A1", "CD14", "FCGR3A", 
                 "NKG7", "GNLY", "FOXP3", "MZB1")
key_markers_present <- key_markers[key_markers %in% rownames(seurat_integrated)]

if (length(key_markers_present) > 0) {
    png('plots/feature_plot_key_markers.png',
    width = 4000, height = ceiling(length(key_markers_present)/3) * 800, res = 300)
    print(FeaturePlot(seurat_integrated, features = key_markers_present, ncol = 3))
    dev.off()
}
```

## Find Cluster markers for annotations

```{r}
if (!file.exists('data/cluster_markers.rds')) {
    all_markers <- FindAllMarkers(seurat_integrated,
                                    only.pos = TRUE,
                                    min.pct = 0.25,
                                    logfc.threshold = 0.25)
    saveRDS(all_markers, 'data/cluster_markers.rds')
    write.csv(all_markers, 'plots/cluster_markers.csv', row.names = FALSE)
} else {
    all_markers <- readRDS('data/cluster_markers.rds')
}
```

### Saving the Top 10 markers

```{r}
top10_markers <- all_markers %>%
    group_by(cluster) %>%
    top_n(n = 10, wt = avg_log2FC)

write.csv(top10_markers, 'plots/top10_cluster_markers.csv', row.names = FALSE)
```

## Dot Plot of canonical markers

```{r}
png('plots/dotplot_canonical_markers.png', width = 3500, height = 2000, res = 300)
print(DotPlot(seurat_integrated, features = key_markers_present) +
    RotatedAxis() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
)
dev.off()
```

# Cell Composition Analysis

```{r}
cat('\n--- Step 3: Cell Composition Analysis ---\n')

cell_composition <- seurat_integrated@meta.data %>%
    group_by(Sample_ID, Condition, seurat_clusters) %>%
    summarise(count = n(), .groups = 'drop') %>%
    group_by(Sample_ID, Condition) %>%
    mutate(
        total = sum(count),
        proportion = count/total * 100
    )
write.csv(cell_composition, 'plots/cell_composition_per_sample.csv', row.names = FALSE)
```

## Composition Stats

```{r}
composition_stats <- data.frame()

for (cluster in unique(cell_composition$seurat_clusters)) {
    cluster_data <- cell_composition %>%
        filter(seurat_clusters == cluster) %>%
        select(Sample_ID, Condition, proportion)

    osa_prop <- cluster_data %>% filter(Condition == 'OSA') %>% pull(proportion)
    control_prop <- cluster_data %>% filter(Condition == 'Control') %>% pull(proportion)

    if (length(osa_prop) > 0 && length(control_prop) > 0) {
        test_result <- wilcox.test(osa_prop, control_prop)
        
        composition_stats <- rbind(composition_stats, data.frame(
            cluster = cluster,
            mean_OSA = mean(osa_prop),
            mean_Control = mean(control_prop),
            sd_OSA = sd(osa_prop),
            sd_Control = sd(control_prop),
            p_value = test_result$p.value,
            significant = test_result$p.value < 0.05
        ))
    }
}

composition_stats <- composition_stats %>% arrange(p_value)
write.csv(composition_stats, 'plots/composition_statistics.csv', row.names = FALSE)
```

### Visualizing the composition stats

```{r}
cat("\nClusters with significant composition differences:\n")
print(composition_stats %>% filter(significant))

# Visualization - box plots
composition_plot_data <- cell_composition %>%
    group_by(seurat_clusters, Condition) %>%
    summarise(
        mean_prop = mean(proportion),
        sd_prop = sd(proportion),
        .groups = 'drop'
    )

p_comp <- ggplot(composition_plot_data, aes(x = seurat_clusters, y = mean_prop, fill = Condition)) +
    geom_bar(stat = "identity", position = "dodge") +
    geom_errorbar(aes(ymin = mean_prop - sd_prop, ymax = mean_prop + sd_prop),
                  position = position_dodge(0.9), width = 0.2) +
    scale_fill_manual(values = c("Control" = "#4DBBD5", "OSA" = "#E64B35")) +
    theme_classic() +
    labs(title = "Cell Composition: OSA vs Control",
         x = "Cluster", y = "Proportion (%)") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

png('plots/cell_composition_barplot.png', width = 3000, height = 2000, res = 300)
print(p_comp)
dev.off()
```

# Overall Differential Expression (All Cells)

```{r}
cat('\n--- Step 4: Overall Differential Expression Analysis ---\n')

Idents(seurat_integrated) <- 'Condition'
if (!file.exists('data/DE_OSA_vs_control_overall.rds')) {
    cat('Running Overall DE analysis')
    DE_overall <- FindMarkers(
        seurat_integrated, 
        ident.1 = 'OSA', ident.2 = 'Control',
        min.pct = 0.1, logfc.threshold = 0.25,
        test.use = 'wilcox'
    )

    DE_overall$gene <- rownames(DE_overall)
    DE_overall <- DE_overall %>% arrange(p_val_adj)

    saveRDS(DE_overall, 'data/DE_OSA_vs_control_overall.rds')
    write.csv(DE_overall, 'plots/DE_OSA_vs_control_overall.csv', row.names=FALSE)
} else {
    DE_overall <- readRDS('data/DE_OSA_vs_control_overall.rds')
}

cat("Total DEGs (padj < 0.05):", sum(DE_overall$p_val_adj < 0.05), "\n")
cat("  Upregulated in OSA:", sum(DE_overall$p_val_adj < 0.05 & DE_overall$avg_log2FC > 0), "\n")
cat("  Downregulated in OSA:", sum(DE_overall$p_val_adj < 0.05 & DE_overall$avg_log2FC < 0), "\n")
```

# Cell-type specific DE Analysis


```{r}
cat("\n=== Step 5: Cell-type-specific DE analysis ===\n")

seurat_integrated$celltype.group <- paste(seurat_integrated$seurat_clusters, 
                                          seurat_integrated$Condition, sep = "_")
Idents(seurat_integrated) <- "celltype.group"

cluster_DE_results <- list()
cluster_gene_counts <- data.frame()

for (cluster in sort(unique(seurat_integrated$seurat_clusters))) {
    cat("Analyzing cluster ", cluster, '\n')

    ident1 <- paste0(cluster, '_OSA')
    ident2 <- paste0(cluster, '_Control')

    if (ident1 %in% levels(Idents(seurat_integrated)) &&
        ident2 %in% levels(Idents(seurat_integrated))) {
            tryCatch({
                DE_cluster <- FindMarkers(
                    seurat_integrated,
                    ident.1 = ident1, ident.2 = ident2,
                    min.pct = 0.1, logfc.threshold = 0.25,
                    test.use = 'wilcox', verbose = FALSE
                )

                DE_cluster$gene <- rownames(DE_cluster)
                DE_cluster$cluster <- cluster
                cluster_DE_results[[as.character(cluster)]] <- DE_cluster

                # Count Significant genes
                n_sig = sum(DE_cluster$p_val_adj < 0.05)
                n_up <- sum(DE_cluster$p_val_adj < 0.05 & DE_cluster$avg_log2FC > 0)
                n_down <- sum(DE_cluster$p_val_adj < 0.05 & DE_cluster$avg_log2FC < 0)

                cluster_gene_counts <- rbind(cluster_gene_counts, data.frame(
                cluster = cluster,
                total_DEG = n_sig,
                upregulated = n_up,
                downregulated = n_down
                ))
            
                write.csv(DE_cluster, 
                        paste0('plots/DE_cluster_', cluster, '_OSA_vs_Control.csv'), 
                        row.names = FALSE)
            }, error = function(e) {
            cat("  Error in cluster", cluster, ":", e$message, "\n")
        })
    }
}


all_cluster_DE <- bind_rows(cluster_DE_results)
saveRDS(all_cluster_DE, 'data/all_cluster_DE_results.rds')
write.csv(all_cluster_DE, 'plots/all_cluster_DE_results.csv', row.names = FALSE)
write.csv(cluster_gene_counts, 'plots/cluster_DEG_counts.csv', row.names = FALSE)

# Replicate Figure 1c - Number of DE genes per cluster
p_deg_counts <- ggplot(cluster_gene_counts, aes(x = cluster, y = total_DEG)) +
    geom_bar(stat = "identity", fill = "steelblue") +
    theme_classic() +
    labs(title = "Differentially Expressed Genes per Cluster",
         x = "Cluster", y = "Number of DEGs") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

png('plots/DEG_counts_per_cluster.png', width = 2400, height = 2000, res = 300)
print(p_deg_counts)
dev.off()
```

# Identification of OSA-associated Pathway Genes

```{r}
cat("\n--- Step 6: Identifying OSA-associated Pathway Genes ---\n")
```

## Defining a list of OSA related pathway genes

```{r}
osa_pathway_genes <- list(
  "KEGG_HIF1_GF_RTK_HIF1a_translation" = c(
    "EGF", "EGFR", "ERBB2", "IGF1", "IGF1R", "INS", "INSR"
  ),
  "KEGG_HIF1_MTOR_HIF1a_translation" = c(
    "EIF4E", "EIF4E1B", "EIF4E2", "EIF4EBP1", "MTOR",
    "RPS6", "RPS6KB1", "RPS6KB2"
  ),
  "KEGG_HIF1_IH_HIF1a_degradation" = c(
    "CYBB", "EGLN1", "EGLN2", "EGLN3", "PLCG1", "PLCG2", "PRKCA"
  ),
  "KEGG_HIF1_HIF1a_degradation_ubiquitin" = c(
    "CUL2", "ELOB", "ELOC", "RBX1", "VHL"
  ),
  "KEGG_HIF1_IH_HIF1b_activation" = c(
    "ARNT", "CAMK2A", "CAMK2B", "CAMK2D", "CAMK2G",
    "CREBBP", "CYBB", "EP300", "PLCG1", "PLCG2"
  ),
  "KEGG_HIF1_RBC" = c(
    "EPO", "TF", "TFRC"
  ),
  "KEGG_HIF1_angiogenesis" = c(
    "ANGPT1", "ANGPT2", "ANGPT4", "EGF", "FLT1",
    "SERPINE1", "TEK", "TIMP1", "VEGFA"
  ),
  "KEGG_HIF1_vascular_tone" = c(
    "EDN1", "HMOX1", "NOS2", "NOS3", "NPPA"
  ),
  "KEGG_HIF1_glucose_inhibit_citrate" = c(
    "PDHA1", "PDHA2", "PDHB", "PDK1", "SLC2A1"
  ),
  "KEGG_HIF1_glucose_promote_anaerobic" = c(
    "ALDOA", "ENO1", "ENO2", "ENO3", "ENO4",
    "GAPDH", "HK2", "HK3", "HKDC1", "LDHA",
    "PFKFB3", "PFKL", "PGK1"
  ),
  "KEGG_HIF1_glucose_regulate_proliferation" = c(
    "BCL2", "CDKN1A", "CDKN1B"
  ),
  "KEGG_VEGF_proliferation" = c(
    "HRAS", "KRAS", "MAP2K1", "MAP2K2", "MAPK1", "MAPK3",
    "NRAS", "PLCG1", "PLCG2", "PRKCA", "PRKCB", "PRKCG",
    "RAF1", "SPHK1", "SPHK2"
  ),
  "KEGG_VEGF_PGI2_production" = c(
    "NFATC2", "PPP3CA", "PPP3CB", "PPP3CC",
    "PPP3R1", "PPP3R2", "PTGS2"
  ),
  "KEGG_VEGF_migration" = c(
    "CDC42", "MAPK11", "MAPK12", "MAPK13", "MAPK14",
    "MAPKAPK2", "MAPKAPK3", "PTK2", "PXN"
  ),
  "KEGG_VEGF_endothelial_permeability" = c(
    "AKT1", "AKT2", "AKT3", "NOS3",
    "PIK3CA", "PIK3CB", "PIK3CD",
    "PIK3R1", "PIK3R2", "PIK3R3",
    "RAC1", "RAC2", "RAC3", "SRC"
  ),
  "KEGG_VEGF_endothelial_survival" = c(
    "AKT1", "AKT2", "AKT3", "BAD", "CASP9",
    "PIK3CA", "PIK3CB", "PIK3CD",
    "PIK3R1", "PIK3R2", "PIK3R3",
    "SRC"
  ),
  "KEGG_HIF1_VEGF_shared_MAPK" = c(
    "MAP2K1", "MAP2K2", "MAPK1", "MAPK3", "MKNK1", "MKNK2"
  ),
  "KEGG_HIF1_VEGF_shared_PI3K_AKT" = c(
    "AKT1", "AKT2", "AKT3",
    "PIK3CA", "PIK3CB", "PIK3CD",
    "PIK3R1", "PIK3R2", "PIK3R3"
  ),
  "KEGG_HIF1_NFkB_related" = c(
    "IFNG", "IFNGR1", "IFNGR2", "IL6", "IL6R",
    "STAT3", "TLR4"
  ),
  "KEGG_NFkB_atypical" = c(
    "BCL2A1", "BCL2L1", "CSNK2A1", "CSNK2A2", "CSNK2A3",
    "CSNK2B", "EGF", "EGFR", "ERBB2",
    "NFKB1", "NFKBIA", "PLAU", "RELA"
  ),
  "KEGG_NFkB_atypical_upstream" = c(
    "BAG4", "IL1B", "IL1R1", "IRAK1", "IRAK4",
    "MYD88", "RIPK1", "TNF", "TNFRSF11A",
    "TNFRSF1A", "TNFSF11", "TRADD",
    "TRAF2", "TRAF5", "TRAF6"
  ),
  "KEGG_TNF_JNK" = c(
    "FOS", "JUN", "MAP2K4", "MAP2K7",
    "MAP3K7", "MAPK10", "MAPK8", "MAPK9",
    "TAB1", "TAB2"
  ),
  "KEGG_TNF_p38" = c(
    "ATF2", "ATF4", "ATF6B",
    "CREB1", "CREB3", "CREB3L1", "CREB3L2",
    "CREB3L3", "CREB3L4", "CREB5",
    "MAP2K3", "MAP2K6", "MAP3K7",
    "MAPK14", "RPS6KA4", "RPS6KA5",
    "TAB1", "TAB2"
  ),
  "KEGG_NFkB_TNF" = c(
    "BIRC2", "BIRC3", "CHUK",
    "IKBKB", "IKBKG",
    "MAP3K14", "MAP3K7",
    "NFKB1", "NFKBIA", "RELA",
    "RIPK1", "TAB1", "TAB2", "TAB3",
    "TNF", "TNFRSF1A", "TRADD",
    "TRAF2", "TRAF5"
  ),
  "KEGG_NFkB_survival" = c(
    "BCL2", "BCL2A1", "BCL2L1",
    "CFLAR", "GADD45B", "TRAF1", "XIAP"
  ),
  "KEGG_NFkB_inflammation" = c(
    "CCL4", "CCL4L1", "CCL4L2",
    "CXCL1", "CXCL2", "CXCL3", "CXCL8",
    "PTGS2", "TNFAIP3", "VCAM1"
  ),
  "KEGG_TNF_apoptosis" = c(
    "CASP10", "CASP3", "CASP7", "CASP8",
    "CFLAR", "FADD", "ITCH"
  ),
  "KEGG_TNF_necroptosis" = c(
    "DNM1L", "MLKL", "PGAM5", "RIPK1", "RIPK3"
  ),
  "KEGG_TNF_immune_signaling" = c(
    "BCL3", "CCL2", "CCL20", "CCL5",
    "CSF1", "CSF2",
    "CX3CL1", "CXCL1", "CXCL10",
    "CXCL2", "CXCL3", "CXCL5",
    "FAS", "IL15", "IL18R1", "IL1B",
    "IL6", "JAG1", "LIF", "LTA",
    "RAF1", "SOCS3", "TNFAIP3"
  ),
  "KEGG_TNF_intracellular_signaling" = c(
    "EDN1", "FOS", "ICAM1", "JUN", "JUNB",
    "MMP14", "MMP3", "MMP9",
    "NOD2", "PTGS2", "SELE", "VCAM1", "VEGFC"
  ),
   "Hypoxia_HIF1A" = c("HIF1A", "VEGFA", "LDHA", "ENO1", "SLC2A1", "PDK1",
                      "BNIP3", "NDRG1", "EGLN1", "EGLN3"),
  "Oxidative_Stress" = c("SOD1", "SOD2", "CAT", "GPX1", "HMOX1", "NQO1",
                         "TXNRD1", "PRDX1", "GCLC"),
  "NFkB_Signaling" = c("NFKB1", "NFKB2", "RELA", "RELB", "NFKBIA", "IKBKB",
                       "TNF", "IL1B", "IL6"),
  "Interferon_Response" = c("IFNG", "IFNAR1", "STAT1", "STAT2", "IRF7",
                            "ISG15", "MX1", "OAS1", "IFIT1"),
  "Nitric_Oxide_ROS" = c("NOS2", "NOS3", "NOX2", "CYBB", "NCF1", "NCF2")
)

```

```{r}
pathway_de_summary <- data.frame()

for (pathway in names(osa_pathway_genes)) {
    genes <- osa_pathway_genes[[pathway]]

    # Check in overall DE
    pathway_genes_de <- DE_overall %>%
        filter(gene %in% genes, p_val_adj < 0.05)

    if (nrow(pathway_genes_de) > 0) {
        pathway_genes_de$pathway <- pathway
        pathway_de_summary <- rbind(pathway_de_summary, pathway_genes_de)
    }
}

if (nrow(pathway_de_summary) > 0) {
    write.csv(pathway_de_summary, 'plots/OSA_pathway_genes_DE.csv', row.names = FALSE)
    
    cat("\nOSA pathophysiology genes found:\n")
    print(pathway_de_summary %>% 
          group_by(pathway) %>% 
          summarise(n_genes = n(), .groups = 'drop'))
}
```

# Building Molecular Signature

```{r}
cat("\n--- Step 7: Building Molecular Signature ---\n")

biomarker_candidates <- DE_overall %>%
    filter(
        p_val_adj < 0.01,
        abs(avg_log2FC) > 0.5,
        (pct.1 > 0.25 | pct.2 > 0.25)
    ) %>%
        arrange(p_val_adj) %>%
        head(50)

biomarker_candidates$pathway <- NA
for (pathway in names(osa_pathway_genes)) {
    genes <- osa_pathway_genes[[pathway]]
    biomarker_candidates$pathway[biomarker_candidates$gene %in% genes] <- pathway
}

write.csv(biomarker_candidates, 'plots/biomarker_signature_candidates.csv', row.names = FALSE)
```

# Comprehensive Visualizations

```{r}
DE_overall$significant <- ifelse(
    DE_overall$p_val_adj < 0.05 & abs(DE_overall$avg_log2FC) > 0.5,
    'significant', 'not significant'
)

DE_overall$label <- ''
top_genes <- head(biomarker_candidates$gene)
DE_overall$label[DE_overall$gene %in% top_genes] <- DE_overall$gene[DE_overall$gene %in% top_genes]
```

## Volcano Plot

```{r}
p_volcano <- ggplot(DE_overall, aes(x = avg_log2FC, y = -log10(p_val_adj), 
                                    color = significant, label = label)) +
    geom_point(alpha = 0.4, size = 1) +
    scale_color_manual(values = c("Significant" = "red", "Not Significant" = "grey")) +
    geom_vline(xintercept = c(-0.5, 0.5), linetype = "dashed", color = "blue") +
    geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "blue") +
    ggrepel::geom_text_repel(size = 3, max.overlaps = 15) +
    theme_classic() +
    labs(title = "Volcano Plot: OSA vs Control",
         x = "Log2 Fold Change",
         y = "-Log10 Adjusted P-value")

png('plots/volcano_plot_labeled.png', width = 3200, height = 2400, res = 300)
print(p_volcano)
dev.off()
```

## Heatmap

```{r}
# 8.2 Heatmap of top biomarkers by Group
top_biomarkers <- biomarker_candidates$gene
top_biomarkers <- top_biomarkers[top_biomarkers %in% rownames(seurat_integrated)]

if (length(top_biomarkers) > 0) {
    Idents(seurat_integrated) <- "Condition"
    
    png('plots/heatmap_top_biomarkers_by_group.png', width = 2400, height = 3000, res = 300)
    print(DoHeatmap(seurat_integrated, features = top_biomarkers, 
                    group.by = "Condition", size = 4) +
          scale_fill_gradientn(colors = c("blue", "white", "red")))
    dev.off()
}
```


```{r}
saveRDS(seurat_integrated, 'data/final_seurat_object.rds')
```